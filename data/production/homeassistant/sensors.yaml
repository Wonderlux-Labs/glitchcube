# Glitch Cube Health and Status Sensors
# These sensors monitor the art installation's health and state

# REST Health Sensors
- platform: rest
  resource: "http://glitchcube.local:4567/health"
  name: "Glitch Cube App Health"
  unique_id: "glitchcube_app_health"
  scan_interval: 30  # Check every 30 seconds
  timeout: 10
  headers:
    User-Agent: "Home Assistant Health Check"
  value_template: >
    {% if value_json is defined and value_json.status == "ok" %}
      online
    {% else %}
      offline
    {% endif %}
  json_attributes:
    - version
    - uptime
    - redis_status
    - database_status
  icon: "mdi:cube-outline"
  
# Internet Connectivity Health
- platform: rest
  resource: "http://httpbin.org/get"
  name: "Internet Connectivity"
  unique_id: "internet_connectivity"
  scan_interval: 60  # Check every minute
  timeout: 15
  value_template: >
    {% if value_json is defined %}
      connected
    {% else %}
      disconnected
    {% endif %}
  icon: "mdi:web"

# Template Sensors for Dynamic State Management
- platform: template
  sensors:
    # Last Interaction Time (updated via webhook)
    last_interaction_time:
      unique_id: "last_interaction_time"
      friendly_name: "Last Interaction Time"
      value_template: "{{ states('input_datetime.last_interaction') | as_timestamp | timestamp_custom('%Y-%m-%d %H:%M:%S') if states('input_datetime.last_interaction') != 'unknown' else 'Never' }}"
      icon_template: "mdi:clock-outline"
      
    # Current Persona (updated via webhook)
    current_persona:
      unique_id: "current_persona"
      friendly_name: "Current Persona"
      value_template: "{{ states('input_text.current_persona') if states('input_text.current_persona') != 'unknown' else 'Default' }}"
      icon_template: "mdi:account-multiple"
      
    # Installation Health Summary
    installation_health:
      unique_id: "installation_health"
      friendly_name: "Installation Health"
      value_template: >
        {% set app_health = states('sensor.glitch_cube_app_health') %}
        {% set internet = states('sensor.internet_connectivity') %}
        {% set temp = states('sensor.cube_cpu_thermal_0_temperature') | float(0) %}
        {% set offline_mode = states('input_boolean.offline_mode') %}
        
        {% if app_health == 'offline' %}
          critical
        {% elif internet == 'disconnected' and offline_mode == 'on' %}
          offline
        {% elif internet == 'disconnected' %}
          degraded
        {% elif temp > 158 %}
          warning
        {% else %}
          healthy
        {% endif %}
      icon_template: >
        {% set health = states('sensor.installation_health') %}
        {% if health == 'critical' %}
          mdi:alert-circle
        {% elif health == 'offline' %}
          mdi:wifi-off
        {% elif health == 'degraded' %}
          mdi:alert
        {% elif health == 'warning' %}
          mdi:alert-outline
        {% else %}
          mdi:check-circle
        {% endif %}
        
    # Current Status Summary (for external status page)
    current_status:
      unique_id: "current_status"
      friendly_name: "Current Status"
      value_template: >
        {% set health = states('sensor.installation_health') %}
        {% set location = "Black Rock Desert, NV" %}
        {% set persona = states('sensor.current_persona') %}
        {% set last_interaction = states('sensor.last_interaction_time') %}
        {% set temp = states('sensor.cube_cpu_thermal_0_temperature') %}
        {% set internet = states('sensor.internet_connectivity') %}
        {% set app_health = states('sensor.glitch_cube_app_health') %}
        {% set weather = states('input_text.current_weather') %}
        {% set env = states('input_text.current_environment') %}
        
        {% set status_parts = [] %}
        {% set status_parts = status_parts + ['📍 ' + location] %}
        {% set status_parts = status_parts + ['🎭 ' + persona] %}
        {% set status_parts = status_parts + ['🏥 ' + health.title()] %}
        
        {% if temp != 'unknown' %}
          {% set status_parts = status_parts + ['🌡️ ' + temp + '°F'] %}
        {% endif %}
        
        {% if internet == 'connected' %}
          {% set status_parts = status_parts + ['🌐 Online'] %}
        {% else %}
          {% set status_parts = status_parts + ['📶 Offline'] %}
        {% endif %}
        
        {% if last_interaction != 'Never' and last_interaction != 'unknown' %}
          {% set status_parts = status_parts + ['💬 Last: ' + last_interaction] %}
        {% endif %}
        
        {% if weather != 'unknown' and weather != '' %}
          {% set status_parts = status_parts + ['☀️ ' + weather[:30] + ('...' if weather|length > 30 else '')] %}
        {% endif %}
        
        {% if env != 'unknown' and env != '' %}
          {% set status_parts = status_parts + ['🌍 ' + env[:30] + ('...' if env|length > 30 else '')] %}
        {% endif %}
        
        {{ status_parts | join(' | ') }}
      icon_template: >
        {% set health = states('sensor.installation_health') %}
        {% if health == 'critical' %}
          mdi:alert-circle-outline
        {% elif health == 'offline' %}
          mdi:cloud-off-outline
        {% elif health == 'degraded' %}
          mdi:alert-outline
        {% elif health == 'warning' %}
          mdi:thermometer-alert
        {% else %}
          mdi:status-bar
        {% endif %}
  
# Note: Using Glances sensors instead:
# - sensor.cube_cpu_thermal_0_temperature (Fahrenheit)
# - sensor.cube_uptime